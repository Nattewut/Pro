{% extends 'store/main.html' %}
{% load static %}

{% block content %}
<div class="row">
    <div class="col-lg-6">
        <div class="box-element" id="form-wrapper">
            <form id="form">
                <div id="user-info">
                    <div class="form-field">
                        <input required class="form-control" type="text" name="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠...">
                    </div>
                    <div class="form-field">
                        <input required class="form-control" type="email" name="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå...">
                    </div>
                </div>

                <div id="shipping-info">
                    <hr>
                    <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</p>
                    <hr>
                    <div class="form-field">
                        <input class="form-control" type="text" name="address" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà...">
                    </div>
                    <div class="form-field">
                        <input class="form-control" type="text" name="city" placeholder="‡πÄ‡∏°‡∏∑‡∏≠‡∏á...">
                    </div>
                    <div class="form-field">
                        <input class="form-control" type="text" name="state" placeholder="‡∏£‡∏±‡∏ê...">
                    </div>
                    <div class="form-field">
                        <input class="form-control" type="text" name="zipcode" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå...">
                    </div>
                    <div class="form-field">
                        <input class="form-control" type="text" name="country" placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®...">
                    </div>
                </div>

                <hr>
                <input id="form-button" class="btn btn-success btn-block" type="submit" value="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠">
            </form>
        </div>

        <br>
        <div class="box-element hidden" id="payment-info">
            <button id="checkout-button">‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="box-element">
            <a class="btn btn-outline-dark" href="{% url 'cart' %}">&#x2190; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</a>
            <hr>
            <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
            <hr>
            {% for item in items %}
            <div class="cart-row">
                <div style="flex:2"><img class="row-image" src="{{ item.product.imageURL }}"></div>
                <div style="flex:2"><p>{{ item.product.name }}</p></div>
                <div style="flex:1"><p>‡∏ø{{ item.product.price|floatformat:2 }}</p></div>
                <div style="flex:1"><p>x{{ item.quantity }}</p></div>
            </div>
            {% endfor %}
            <h5>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: {{ order.get_cart_items }}</h5>
            <h5>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ‡∏ø{{ order.get_cart_total|floatformat:2 }}</h5>
        </div>

        <div class="box-element hidden" id="qr-code-section">
            <h4>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ QR Code</h4>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</p>
            <img id="qr-code" src="" alt="QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô">
        </div>
    </div>
</div>

<!-- Hidden CSRF Token -->
<input type="hidden" id="csrf-token" value="{{ csrf_token }}">

<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
        console.log("‚úÖ JavaScript ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");

        let checkoutButton = document.getElementById("checkout-button");
        if (!checkoutButton) {
            console.error("‚ùå ‡∏õ‡∏∏‡πà‡∏° 'checkout-button' ‡πÑ‡∏°‡πà‡∏û‡∏ö!");
            return;
        }

        checkoutButton.addEventListener("click", function () {
            console.log("üìå ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á /create-checkout-session/");

            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ CSRF Token ‡∏à‡∏≤‡∏Å hidden input
            let csrfToken = document.getElementById("csrf-token").value;

            fetch(window.location.origin + "/create-checkout-session/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken
                },
                body: JSON.stringify({
                    total_amount: {{ order.get_cart_total|floatformat:2 }}
                })
            })
            .then(response => {
                console.log("‚úÖ Response Status:", response.status);
                return response.json();
            })
            .then(data => {
                console.log("‚úÖ Response Data:", data);
                if (data.qr_code_url) {
                    const img = document.getElementById("qr-code");
                    img.src = data.qr_code_url;
                    img.style.display = "block";
                    document.getElementById("qr-code-section").classList.remove("hidden");
                } else {
                    console.error("‚ùå QR Code URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
            })
            .catch(error => alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message));
        });
    });
</script>
{% endblock content %}

